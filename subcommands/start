#!/usr/bin/env bash
source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/../config"
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

cmd-dokku-api-start() {
  declare desc="Deploy the Dokku-API into Dokku"
  declare cmd="$PLUGIN_COMMAND_PREFIX:start"
  [[ "$1" == "$cmd" ]] && shift 1

  local APP="${1:-$DEFAULT_APP}"
  local REPO="${2:-$DEFAULT_REPO}"
  local REF="${3:-$DEFAULT_REF}"

  local DB_NAME="${APP}-db"
  local APP_VOLUME_DIR="/app/storage"
  local APP_SSH_KEY_PATH="$APP_VOLUME_DIR/id_rsa"

  # Install the database
  if ! dokku mysql:help >/dev/null 2>&1; then
    dokku plugin:install https://github.com/dokku/dokku-mysql.git mysql
  fi

  if ! dokku mysql:exists "$DB_NAME" >/dev/null 2>&1; then
    dokku mysql:create "$DB_NAME"
  fi

  # Build the application
  if ! dokku apps:exists "$APP" >/dev/null 2>&1; then
    dokku apps:create "$APP"
  fi

  dokku builder:set "$APP" selected dockerfile
  dokku mysql:link "$DB_NAME" "$APP" >/dev/null 2>&1 || true

  # Check if the application was configured previously
  existing_config="$(dokku config:show "$APP" 2>/dev/null || true)"
  if ! { [[ -n "$existing_config" ]] && printf "%s" "$existing_config" | grep -q "^SSH_HOSTNAME: "; }; then
    config_api "$APP" "$APP_VOLUME_DIR" "$APP_SSH_KEY_PATH"
  fi

  # Deploy from GitHub repository
  dokku git:sync --build "$APP" "$REPO" "$REF"
}

config_api() {
  local app_name="$1"
  local app_volume_dir="$2"
  local app_ssh_key_path="$3"
  local existing_config=""

  local VOLUME_DIR="/var/lib/dokku/data/storage"

  # Get required data from user input
  echo "Please fill in the information below:"
  read -r -p "SSH Hostname: " SSH_HOSTNAME
  read -r -p "SSH Port: " SSH_PORT
  read -r -p "SSH Key Path: " SSH_KEY_PATH

  # Get / Generate API secrets
  local API_KEY=""
  local MASTER_KEY=""

  read -r -p "Auto-generate API and MASTER keys? [y/N]: " AUTO_KEYS
  case "$AUTO_KEYS" in
    [yY])
      if ! API_KEY="$(cat /proc/sys/kernel/random/uuid 2>/dev/null)"; then
        echo "Failed to generate API_KEY from /proc/sys/kernel/random/uuid" >&2
        exit 1
      fi
      if ! MASTER_KEY="$(cat /proc/sys/kernel/random/uuid 2>/dev/null)"; then
        echo "Failed to generate MASTER_KEY from /proc/sys/kernel/random/uuid" >&2
        exit 1
      fi
      if [[ -z "$API_KEY" || -z "$MASTER_KEY" ]]; then
        echo "Generated secrets are empty" >&2
        exit 1
      fi
      echo "API_KEY: $API_KEY"
      echo "MASTER_KEY: $MASTER_KEY"
      ;;
    *)
      while [[ -z "$API_KEY" ]]; do
        read -r -p "API_KEY: " API_KEY
      done
      while [[ -z "$MASTER_KEY" ]]; do
        read -r -p "MASTER_KEY: " MASTER_KEY
      done
      ;;
  esac

  # Mount storage and save SSH key into the application
  mkdir -p "$VOLUME_DIR/$app_name"
  cp "$SSH_KEY_PATH" "$VOLUME_DIR/$app_name/id_rsa"
  chmod 644 "$VOLUME_DIR/$app_name/id_rsa"

  dokku storage:mount "$app_name" "$VOLUME_DIR/$app_name:$app_volume_dir"

  # Configure the application
  dokku config:set --no-restart "$app_name" \
    VOLUME_DIR="$app_volume_dir" \
    SSH_KEY_PATH="$app_ssh_key_path" \
    SSH_HOSTNAME="$SSH_HOSTNAME" \
    SSH_PORT="$SSH_PORT" \
    API_KEY="$API_KEY" \
    MASTER_KEY="$MASTER_KEY"

  # Setup NGINX config
  dokku nginx:set "$app_name" client-max-body-size 1024M >/dev/null 2>&1
  dokku proxy:build-config "$app_name" >/dev/null 2>&1
}

cmd-dokku-api-start "$@"